<!DOCTYPE html>
<html lang="es">

<head>
    <link rel="icon" href="favicon.ico" type="image/x-icon">
    <meta charset="UTF-8">
    <title>Planilla de Asignaciones</title>
    <style>
        table {
            width: 100%;
            border-collapse: collapse;
            margin-top: 1em;
        }

        th,
        td {
            border: 1px solid #aaa;
            padding: 0.5em;
            text-align: center;
        }

        th {
            background-color: #f0f0f0;
        }

        form {
            margin-bottom: 1em;
        }

        body {
            background-color: #f5f5f5;
            margin: 0;
            padding: 0;
            font-family: Arial, sans-serif;
            display: flex;
            justify-content: center;
        }

        .container {
            max-width: 900px;
            width: 100%;
            padding: 20px;
            box-sizing: border-box;
        }

        .card {
            background-color: #fff;
            border-radius: 8px;
            box-shadow: 0 2px 8px rgba(0, 0, 0, 0.1);
            padding: 20px;
            margin-bottom: 20px;
            display: flex;
            flex-direction: column;
        }

        #generarAsignaciones {
            background-color: #007bff;
            color: #fff;
            border: none;
            padding: 10px 20px;
            border-radius: 4px;
            cursor: pointer;
            font-size: 1em;
        }

        #generarAsignaciones:hover {
            background-color: #0056b3;
        }

        #limpiarPersona {
            background-color: #c52828;
            color: #fff;
            border: none;
            padding: 10px 20px;
            border-radius: 4px;
            cursor: pointer;
            font-size: 1em;
        }

        #limpiarPersona:hover {
            background-color: #ad2525;
        }


        #limpiarPersonas {
            background-color: #c52828;
            color: #fff;
            border: none;
            padding: 10px 20px;
            border-radius: 4px;
            cursor: pointer;
            font-size: 1em;
        }

        #actualizarPersona:hover {
            background-color: #0056b3;
        }

        #actualizarPersona {
            background-color: #007bff;
            color: #fff;
            border: none;
            padding: 10px 20px;
            border-radius: 4px;
            cursor: pointer;
            font-size: 1em;
        }

        #agregarMesSiguiente {
            background-color: #007bff;
            color: #fff;
            border: none;
            padding: 10px 20px;
            border-radius: 4px;
            cursor: pointer;
            font-size: 1em;
        }

        #agregarMesSiguiente:hover {
            background-color: #0056b3;
        }

        #agregarFecha {
            background-color: #007bff;
            color: #fff;
            border: none;
            padding: 10px 20px;
            border-radius: 4px;
            cursor: pointer;
            font-size: 1em;
        }

        #agregarFecha:hover {
            background-color: #0056b3;
        }

        #limpiarPersonas:hover {
            background-color: #ad2525;
        }

        #agregarNoDisp {
            background-color: #1dad41;
            color: #fff;
            border: none;
            padding: 10px 20px;
            border-radius: 4px;
            cursor: pointer;
            font-size: 1em;
        }

        #agregarNoDisp:hover {
            background-color: #168b33;
        }


        #limpiarNoDisp {
            background-color: #c52828;
            color: #fff;
            border: none;
            padding: 10px 20px;
            border-radius: 4px;
            cursor: pointer;
            font-size: 1em;
        }

        #limpiarNoDisp:hover {
            background-color: #ad2525;
        }

        #agregarPersona {
            background-color: #1dad41;
            color: #fff;
            border: none;
            padding: 10px 20px;
            border-radius: 4px;
            cursor: pointer;
            font-size: 1em;
        }

        #agregarPersona:hover {
            background-color: #168b33;
        }

        #vaciarEventos {
            background-color: #c52828;
            color: #fff;
            border: none;
            padding: 10px 20px;
            border-radius: 4px;
            cursor: pointer;
            font-size: 1em;
        }

        #vaciarEventos:hover {
            background-color: #ad2525;
        }



        .flex-row {
            display: flex;
            gap: 20px;
            flex-wrap: wrap;
        }

        .flex-row .card {
            flex: 1;
            min-width: 300px;
        }

        #formularioPersonas {
            display: flex;
            flex-direction: column;
            gap: 10px;
            border: none;
        }

        #formularioNoDisponibilidad {
            display: flex;
            flex-direction: column;
            gap: 10px;
        }

        #formularioPersonas fieldset {
            display: flex;
            flex-direction: column;
            gap: 5px;
            border: none;
            padding: 0;
        }

        #formularioPersonas legend {
            font-weight: bold;
            margin-bottom: 5px;
        }

        #formularioFechasSemana fieldset {
            display: flex;
            flex-direction: column;
            gap: 5px;
            border: none;
            padding: 0;
            margin: 0;
            margin-top: auto;
        }

        #formularioFechasSemana legend {
            font-weight: bold;
            margin-bottom: 5px;
        }

        #formularioPersonas button {
            margin-top: auto;
        }

        .button-group {
            display: flex;
            gap: 10px;
            margin-top: auto;
        }
    </style>
    <style>
        #formularioFechasSemana>div:nth-child(2) {
            display: flex;
            flex-direction: column;
            gap: 8px;
        }
    </style>
</head>
<style>
    #formularioFechasSemana>div:first-child {
        display: flex;
        flex-direction: column;
        gap: 10px;
    }
</style>
</head>

<body>
    <div class="container">
        <h1>Planilla de Asignaciones para Eventos</h1>

        <div class="flex-row">
            <form class="card" id="formularioPersonas">
                <label for="nombrePersona">Nombre de la Persona:</label>
                <input type="text" id="nombrePersona" name="nombrePersona" required>
                <label for="colorPersona">Color:</label>
                <input type="color" id="colorPersona" name="colorPersona" value="#000000">
                <label><input type="checkbox" id="selectAllRoles"> Asignar todos los roles</label>
                <fieldset>
                    <legend>Roles Permitidos:</legend>
                    <label><input type="checkbox" name="roles" value="Anfitrión" id="cbxAnfitrion"> Anfitrión</label>
                    <label><input type="checkbox" name="roles" value="Coanfitrión" id="cbxCoAnfitrion">
                        Coanfitrión</label>
                    <label><input type="checkbox" name="roles" value="Micrófono 1" id="cbxMicro1"> Micrófono 1</label>
                    <label><input type="checkbox" name="roles" value="Micrófono 2" id="cbxMicro2"> Micrófono 2</label>
                    <label><input type="checkbox" name="roles" value="Plataforma" id="cbxPlataforma"> Plataforma</label>
                </fieldset>
                <div class="button-group">
                    <button type="submit" id="agregarPersona">Agregar Persona</button>
                    <button type="button" id="limpiarPersonas">Vaciar lista de personas</button>
                    <button type="submit" id="actualizarPersona">Actualizar Persona</button>
                </div>
                <select id="eliminarPersona" name="eliminarPersona"></select>
                <button type="button" id="limpiarPersona">Eliminar Persona</button>
            </form>

            <form class="card" id="formularioNoDisponibilidad">
                <label for="fechaNoDisponible">Fecha en la que NO está disponible:</label>
                <input type="date" id="fechaNoDisponible" name="fechaNoDisponible" required>
                <label for="personaNoDisponible">Nombre de la persona:</label>
                <select id="personaNoDisponible" name="personaNoDisponible" required></select>
                <ul id="listaNoDisponibilidades"></ul>
                <div class="button-group">
                    <button type="submit" id="agregarNoDisp">Agregar No Disponibilidad</button>
                    <button type="button" id="limpiarNoDisp">Limpiar No Disponibilidades</button>
                </div>
            </form>
        </div>

        <div class="flex-row">
            <form class="card" id="formularioFechasSemana">
                <div>
                    <label for="fechaEvento">Agregar Fecha del Evento:</label>
                    <input type="date" id="fechaEvento" name="fechaEvento" required>
                    <button type="submit" id="agregarFecha">Agregar Fecha</button>
                </div>
                <hr>
                <fieldset>
                    <legend>Días de la semana</legend>
                    <label><input type="checkbox" name="diasSemana" value="1"> Lunes</label>
                    <label><input type="checkbox" name="diasSemana" value="2"> Martes</label>
                    <label><input type="checkbox" name="diasSemana" value="3"> Miércoles</label>
                    <label><input type="checkbox" name="diasSemana" value="4"> Jueves</label>
                    <label><input type="checkbox" name="diasSemana" value="5"> Viernes</label>
                    <label><input type="checkbox" name="diasSemana" value="6"> Sábado</label>
                    <label><input type="checkbox" name="diasSemana" value="0"> Domingo</label>
                    <button type="button" id="agregarMesSiguiente">Agregar mes siguiente</button>
                </fieldset>
            </form>
            <div class="card">
                <h2>Fechas de Eventos</h2>
                <ul id="listaFechas"></ul>
                <button type="button" id="vaciarEventos">Vaciar Eventos</button>
            </div>
        </div>

        <h2>Asignaciones</h2>
        <div class="card">
            <button id="generarAsignaciones">Generar Asignaciones</button>
            <div id="asignaciones"></div>
        </div>
    </div>

    <script>
        const datosParaGuardar = [];
        const BASE_URL = 'https://asignacionesav.onrender.com';
        document.getElementById('selectAllRoles').addEventListener('change', function () {
            const checked = this.checked;
            document.querySelectorAll('#formularioPersonas input[name="roles"]').forEach(cb => {
                cb.checked = checked;
            });
        });
        function uncheckBox() {
            document.getElementById('selectAllRoles').checked = false;
            document.querySelectorAll('input[name="roles"]').forEach(cb => {
                cb.checked = false;
            });
        }
        let personas = {};
        function actualizarListaFechas() {
            const ul = document.getElementById('listaFechas'); // 
            const diasSemana = ['Domingo', 'Lunes', 'Martes', 'Miércoles', 'Jueves', 'Viernes', 'Sábado'];

            ul.innerHTML = fechasEventos
                .sort()
                .map(fecha => {
                    const [y, m, d] = fecha.split('-').map(Number);
                    const dateObj = new Date(Date.UTC(y, m - 1, d));
                    const nombreDia = diasSemana[dateObj.getUTCDay()];
                    return `
                <li>
                    ${fecha} (${nombreDia}) 
                    <button onclick="eliminarFechaEvento('${fecha}')">❌</button>
                </li>
            `;
                })
                .join('');
        }
        async function cargarPersonasDesdeBackend() {
            try {
                const res = await fetch(`${BASE_URL}/personas`)
                const data = await res.json();
                personas = {};
                data.forEach(p => {
                    personas[p.nombre] = {
                        roles: p.roles,
                        color: p.color || '#000000'
                    };
                });
                actualizarSelectPersonas();
                actualizarSelectPersonasAEliminar();
            } catch (err) {
                console.error("Error cargando personas:", err);
            }
        }
        cargarPersonasDesdeBackend();
        let noDisponibilidades = {};

        document.getElementById('actualizarPersona').addEventListener('click', async () => {
            const nombre = document.getElementById('nombrePersona').value.trim();
            const color = document.getElementById('colorPersona').value;
            const roles = Array.from(document.querySelectorAll('input[name="roles"]:checked')).map(cb => cb.value);

            if (!nombre) {
                alert('Por favor, ingresa un nombre para actualizar.');
                return;
            }

            try {
                const res = await fetch(`${BASE_URL}/personas/${encodeURIComponent(nombre)}`, {
                    method: 'PUT',
                    headers: {
                        'Content-Type': 'application/json'
                    },
                    body: JSON.stringify({ color, roles })
                });

                if (!res.ok) {
                    const error = await res.json();
                    throw new Error(error.mensaje || 'Error al actualizar persona');
                }

                const personaActualizada = await res.json();

                // Actualizar en memoria
                personas[nombre] = personaActualizada;
                actualizarSelectPersonas();
                actualizarSelectPersonasAEliminar(nombre);

                alert('Persona actualizada correctamente.');
            } catch (err) {
                console.error(err);
                alert('Hubo un error al actualizar la persona.');
            }
            event.target.nombrePersona.value = '';
            uncheckBox();
        });

        async function cargarNoDisponibilidades() {
            try {
                const res = await fetch(`${BASE_URL}/no-disponibilidades`);
                const datos = await res.json();
                noDisponibilidades = {};
                datos.forEach(({ fecha, persona }) => {
                    noDisponibilidades[fecha] = noDisponibilidades[fecha] || [];
                    noDisponibilidades[fecha].push(persona);
                });

                actualizarListaNoDisponibilidades(document.getElementById('personaNoDisponible').value);
            } catch (err) {
                console.error("Error al cargar no disponibilidades", err);
            }
        }
        cargarNoDisponibilidades();

        let fechasEventos = [];

        async function cargarFechasEventos() {
            try {
                const response = await fetch(`${BASE_URL}/fechas-eventos`);
                const datos = await response.json();
                fechasEventos = datos.map(e => e.fecha);
                actualizarListaFechas();
            } catch (error) {
                console.error("Error al cargar fechas de eventos", error);
            }
        }
        cargarFechasEventos();

        let assignedThisCycle = new Set();
        const eliminarPersonaSelect = document.getElementById('eliminarPersona');
        const personaNoDisponibleSelect = document.getElementById('personaNoDisponible');
        eliminarPersonaSelect.addEventListener('change', () => {
            const nombre = eliminarPersonaSelect.value;
            personaNoDisponibleSelect.value = nombre;
            actualizarListaNoDisponibilidades(nombre);
            cargarDatosPersona(nombre);
        });

        personaNoDisponibleSelect.addEventListener('change', () => {
            const nombre = personaNoDisponibleSelect.value;
            eliminarPersonaSelect.value = nombre;
            actualizarListaNoDisponibilidades(nombre);
            cargarDatosPersona(nombre);
        });


        document.getElementById('formularioPersonas').addEventListener('submit', async event => {
            event.preventDefault();
            const nombre = event.target.nombrePersona.value.trim();
            const roles = Array.from(event.target.querySelectorAll('input[name="roles"]:checked'))
                .map(cb => cb.value);
            if (!nombre) {
                alert('Ingresa un nombre válido.');
                return;
            }
            if (personas[nombre]) {
                if (!confirm(`La persona "${nombre}" ya existe. ¿Deseas sobreescribir sus roles?`)) {
                    return;
                }
            }
            if (roles.length === 0) {
                alert('Selecciona al menos un rol.');
                return;
            }
            const color = event.target.colorPersona.value;
            const persona = { nombre, roles, color };

            try {
                const res = await fetch(`${BASE_URL}/personas`, {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify(persona)
                });

                if (!res.ok) throw new Error('Error al guardar');

                personas[nombre] = persona;
                actualizarSelectPersonas();
                actualizarSelectPersonasAEliminar();
            } catch (err) {
                console.error("Error al guardar persona:", err);
                alert("No se pudo guardar la persona.");
            }

            event.target.nombrePersona.value = '';
            uncheckBox();
        });

        function cargarDatosPersona(nombre) {
            const persona = personas[nombre];
            if (!persona) return;
            document.getElementById('nombrePersona').value = nombre;
            document.getElementById('colorPersona').value = persona.color || '#000000';
            document.querySelectorAll('input[name="roles"]').forEach(cb => cb.checked = false);
            persona.roles.forEach(rol => {
                const checkbox = Array.from(document.querySelectorAll('input[name="roles"]'))
                    .find(cb => cb.value === rol);
                if (checkbox) checkbox.checked = true;
            });
        }

        function actualizarSelectPersonas() {
            const select = document.getElementById('personaNoDisponible');
            select.innerHTML = Object.keys(personas)
                .sort()
                .map(nombre => `<option value="${nombre}">${nombre}</option>`)
                .join('');
        }
        function actualizarSelectPersonasAEliminar() {
            const select = document.getElementById('eliminarPersona');
            select.innerHTML = Object.keys(personas)
                .sort()
                .map(nombre => `<option value="${nombre}">${nombre}</option>`)
                .join('');
        }


        function actualizarListaNoDisponibilidades(persona) {
            const ul = document.getElementById('listaNoDisponibilidades');
            const diasSemana = ['Domingo', 'Lunes', 'Martes', 'Miércoles', 'Jueves', 'Viernes', 'Sábado'];
            const fechas = Object.keys(noDisponibilidades)
                .filter(fecha => noDisponibilidades[fecha].includes(persona));
            ul.innerHTML = fechas
                .sort()
                .map(f => {
                    const [y, m, d] = f.split('-').map(Number);
                    const dayName = diasSemana[new Date(y, m - 1, d).getDay()];
                    return `
                <li>
                    ${f} (${dayName})
                    <button onclick="eliminarNoDisponibilidad('${f}', '${persona}')">❌</button>
                </li>
            `;
                })
                .join('');
        }

        async function eliminarNoDisponibilidad(fecha, persona) {
            if (!confirm(`¿Eliminar la no disponibilidad de ${persona} en la fecha ${fecha}?`)) return;

            try {
                const res = await fetch(`${BASE_URL}/no-disponibilidades`, {
                    method: 'DELETE',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({ fecha, persona })
                });
                if (!res.ok) throw new Error('Error al eliminar');

                await cargarNoDisponibilidades();
            } catch (error) {
                alert('Error eliminando no disponibilidad: ' + error.message);
            }
        }



        document.getElementById('personaNoDisponible').addEventListener('change', function () {
            actualizarListaNoDisponibilidades(this.value);
        });
        document.getElementById('eliminarPersona').addEventListener('change', function () {
            actualizarListaNoDisponibilidades(this.value);
        });
        actualizarSelectPersonas();
        actualizarListaNoDisponibilidades();
        actualizarSelectPersonasAEliminar();

        document.getElementById('formularioNoDisponibilidad').addEventListener('submit', async event => {
            event.preventDefault();
            const fecha = event.target.fechaNoDisponible.value;
            const persona = event.target.personaNoDisponible.value;
            try {
                const res = await fetch(`${BASE_URL}/no-disponibilidad`, {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({ fecha, persona })
                });

                if (!res.ok) {
                    const msg = await res.json();
                    alert(msg.mensaje || "No se pudo guardar");
                    return;
                }

                noDisponibilidades[fecha] = noDisponibilidades[fecha] || [];
                noDisponibilidades[fecha].push(persona);
                actualizarListaNoDisponibilidades(persona);
                //  event.target.reset();
            } catch (err) {
                console.error("Error al guardar no disponibilidad:", err);
                alert("Hubo un error al guardar.");
            }

        });

        document.getElementById('formularioFechasSemana').addEventListener('submit', async event => {
            event.preventDefault();
            const fecha = event.target.fechaEvento.value;
            try {
                const res = await fetch(`${BASE_URL}/fechas-eventos`, {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({ fecha })
                });
                if (res.ok) {
                    fechasEventos.push(fecha);
                    actualizarListaFechas();
                    event.target.reset();
                } else {
                    const err = await res.json();
                    alert(err.mensaje || 'Error al agregar fecha');
                }
            } catch (error) {
                console.error("Error al agregar fecha", error);
            }
        });


        async function eliminarFechaEvento(fecha) {
            if (!confirm(`¿Eliminar la fecha ${fecha}?`)) return;

            try {
                const res = await fetch(`${BASE_URL}/fechas-eventos/${fecha}`, {
                    method: 'DELETE'
                });

                if (res.ok) {
                    fechasEventos = fechasEventos.filter(f => f !== fecha);
                    actualizarListaFechas();
                } else {
                    const err = await res.json();
                    alert(err.mensaje || 'Error al eliminar la fecha');
                }
            } catch (error) {
                console.error('Error al eliminar la fecha:', error);
                alert('No se pudo conectar con el servidor.');
            }
        }


        document.getElementById('agregarMesSiguiente').addEventListener('click', async () => {
            const checkboxes = document.querySelectorAll('#formularioFechasSemana input[name="diasSemana"]:checked');
            const dias = Array.from(checkboxes).map(cb => parseInt(cb.value));
            if (dias.length === 0) {
                alert('Selecciona al menos un día de la semana.');
                return;
            }

            const hoy = new Date();
            const year = hoy.getFullYear();
            let month = hoy.getMonth() + 1;
            let y = year;
            if (month > 11) { month = 0; y = year + 1; }

            const first = new Date(y, month, 1);
            const last = new Date(y, month + 1, 0);
            const nuevasFechas = [];

            for (let d = new Date(first); d <= last; d.setDate(d.getDate() + 1)) {
                if (dias.includes(d.getDay())) {
                    const iso = d.toISOString().slice(0, 10);
                    if (!fechasEventos.includes(iso)) {
                        nuevasFechas.push(iso);
                    }
                }
            }

            if (nuevasFechas.length === 0) {
                alert('No hay fechas nuevas para agregar.');
                return;
            }

            try {
                const res = await fetch(`${BASE_URL}/fechas-eventos/lote`, {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({ fechas: nuevasFechas })
                });

                if (res.ok) {
                    fechasEventos.push(...nuevasFechas);
                    fechasEventos = [...new Set(fechasEventos)].sort();
                    actualizarListaFechas();
                } else {
                    const err = await res.json();
                    alert(err.mensaje || 'Error al agregar fechas');
                }
            } catch (error) {
                console.error('Error al agregar fechas en lote', error);
            }
        });

        function obtenerDiaYNumero(fechaStr) {
            const fecha = new Date(fechaStr);
            const diasSemana = ['Domingo', 'Lunes', 'Martes', 'Miércoles', 'Jueves', 'Viernes', 'Sábado'];
            const nombreDia = diasSemana[fecha.getUTCDay()];
            const numeroDia = fecha.getUTCDate();
            return `${nombreDia} ${numeroDia}`;
        }
        function esColorOscuro(hex) {
            hex = hex.replace('#', '');
            const r = parseInt(hex.substr(0, 2), 16);
            const g = parseInt(hex.substr(2, 2), 16);
            const b = parseInt(hex.substr(4, 2), 16);
            const luminancia = 0.299 * r + 0.587 * g + 0.114 * b;

            return luminancia < 128;
        }
        //Cargamos ultima tabla

        function mostrarTablaAsignaciones(data) {
            const mesFecha = new Date(data[0].fecha);
            const nombreMes = mesFecha.toLocaleString('es-ES', { month: 'long' });
            const nombreMesMayuscula = nombreMes.charAt(0).toUpperCase() + nombreMes.slice(1);

            let html = `<table><tr><th>${nombreMesMayuscula}</th><th>Anfitrión</th><th>Coanfitrión</th><th>Micrófono 1</th><th>Micrófono 2</th><th>Plataforma</th></tr>`;

            data.forEach(item => {
                const { fecha, asignaciones } = item;
                const diaNumero = obtenerDiaYNumero(fecha);

                html += `<tr><td style="font-weight:bold">${diaNumero}</td>` +
                    ['Anfitrion', 'Coanfitrion', 'Microfono1', 'Microfono2', 'Plataforma']
                        .map(rol => {
                            const nombre = asignaciones[rol];
                            const color = personas[nombre]?.color || '#000000';
                            const textoColor = esColorOscuro(color) ? '#fff' : '#000';
                            const nombreRol = rol.replace('Microfono', 'Micrófono ').replace('Coanfitrion', 'Coanfitrión').replace('Anfitrion', 'Anfitrión');
                            if (!personas[nombre]) {
                                console.warn(`❗ Persona no encontrada: "${nombre}"`);
                            }

                            return `<td 
            style="background-color:${color}; color:${textoColor}; font-weight:bold; cursor:pointer"
            data-persona="${nombre}" 
            data-rol="${nombreRol}" 
            data-fecha="${diaNumero}">
            ${nombre}
          </td>`;
                        })
                        .join('') +
                    '</tr>';
            });

            html += `</table>`;
            document.getElementById('asignaciones').innerHTML = html;

            document.querySelectorAll('#asignaciones td[data-persona]').forEach(td => {
                td.addEventListener('click', () => {
                    const nombre = td.dataset.persona;
                    const rol = td.dataset.rol;
                    const fecha = td.dataset.fecha;

                    const mensajes = {
                        'Anfitrión': `Hola ${nombre}, ¿cómo estás?. Para avisarte que estás de Anfitrión el ${fecha}.\n` +
                            `Solo por recordatorio: tener presente llegar al menos 10 minutos antes, para poder preparar los equipos.\n` +
                            `Queremos que la reunión salga lo mejor posible, para que los hermanos puedan disfrutarla y que sea de alabanza a Jehová.\n` +
                            `¡Muchísimas gracias por tu buena disponibilidad!\n` +
                            `Cuando te sea posible, confirmame la asignación.\n` +
                            `¡Un abrazo grande!`,

                        'Coanfitrión': `Hola ${nombre}, ¿cómo estás?. Para avisarte que estás de Co-Anfitrión el ${fecha}.\n` +
                            `Solo por recordatorio: tener presente llegar al menos 10 minutos antes, para poder preparar los equipos y probar micrófonos.\n` +
                            `Queremos que la reunión salga lo mejor posible, para que los hermanos puedan disfrutarla y que sea de alabanza a Jehová.\n` +
                            `¡Muchísimas gracias por tu buena disponibilidad!\n` +
                            `Cuando te sea posible, confirmame la asignación.\n` +
                            `¡Un abrazo grande!`,

                        'Micrófono 1': `Hola ${nombre}, ¿cómo estás?. Para avisarte que estás como Micrófono 1 el ${fecha}.\n` +
                            `¡Muchísimas gracias por tu buena disponibilidad!\n` +
                            `Cuando te sea posible, confirmame la asignación.\n` +
                            `¡Un abrazo grande!`,

                        'Micrófono 2': `Hola ${nombre}, ¿cómo estás?. Para avisarte que estás como Micrófono 2 el ${fecha}.\n` +
                            `¡Muchísimas gracias por tu buena disponibilidad!\n` +
                            `Cuando te sea posible, confirmame la asignación.\n` +
                            `¡Un abrazo grande!`,

                        'Plataforma': `Hola ${nombre}, ¿cómo estás?. Para avisarte que estás como Plataforma el ${fecha}.\n` +
                            `Solo por recordatorio: tener presente llegar al menos 10 minutos antes, para poder probar los micrófonos y la tablet.\n` +
                            `Queremos que la reunión salga lo mejor posible, para que los hermanos puedan disfrutarla y que sea de alabanza a Jehová.\n` +
                            `¡Muchísimas gracias por tu buena disponibilidad!\n` +
                            `Cuando te sea posible, confirmame la asignación.\n` +
                            `¡Un abrazo grande!`
                    };

                    const mensaje = mensajes[rol];

                    navigator.clipboard.writeText(mensaje)
                        .then(() => {
                            td.style.outline = '2px solid limegreen';
                            setTimeout(() => td.style.outline = '', 1000);
                        })
                        .catch(err => {
                            console.error('Error al copiar al portapapeles: ', err);
                        });
                });
            });
        }

        fetch(`${BASE_URL}/asignaciones-generadas`)
            .then(res => res.json())
            .then(data => {
                if (data && data.length) {
                    mostrarTablaAsignaciones(data);
                }
            })
            .catch(err => console.error('Error al cargar última asignación:', err));


        document.getElementById('generarAsignaciones').addEventListener('click', () => {
            function shuffle(array) {
                for (let i = array.length - 1; i > 0; i--) {
                    const j = Math.floor(Math.random() * (i + 1));
                    [array[i], array[j]] = [array[j], array[i]];
                }
                return array;
            }

            assignedThisCycle.clear();
            let conteoAsignaciones = {};
            Object.keys(personas).forEach(p => conteoAsignaciones[p] = 0);

            const duplasAsignadas = new Set(); // para Anfitrión|Coanfitrión
            let personasAsignadasAnterior = new Set(); // para evitar repetir personas seguidas

            fechasEventos.sort();

            const mesFecha = new Date(fechasEventos[0]);
            const nombreMes = mesFecha.toLocaleString('es-ES', { month: 'long' });
            const nombreMesMayuscula = nombreMes.charAt(0).toUpperCase() + nombreMes.slice(1);


            let html = `<table><tr><th>${nombreMesMayuscula}</th><th>Anfitrión</th><th>Coanfitrión</th><th>Micrófono 1</th><th>Micrófono 2</th><th>Plataforma</th></tr>`;

            fechasEventos.forEach(fecha => {
                let disponibles = Object.keys(personas)
                    .filter(p => !(noDisponibilidades[fecha] || []).includes(p))
                    .filter(p => !personasAsignadasAnterior.has(p)); // evitar repetidos

                const asignacion = {};

                // Asignar Anfitrión y Coanfitrión
                let candidatosAnfitrion = disponibles.filter(p => personas[p].roles.includes('Anfitrión'));
                let candidatosCoanfitrion = disponibles.filter(p => personas[p].roles.includes('Coanfitrión'));

                let preferidosAnfitrion = candidatosAnfitrion.filter(p => conteoAsignaciones[p] < 2);
                let preferidosCoanfitrion = candidatosCoanfitrion.filter(p => conteoAsignaciones[p] < 2);

                if (preferidosAnfitrion.length === 0) preferidosAnfitrion = candidatosAnfitrion.slice();
                if (preferidosCoanfitrion.length === 0) preferidosCoanfitrion = candidatosCoanfitrion.slice();

                shuffle(preferidosAnfitrion);
                shuffle(preferidosCoanfitrion);

                let duplaEncontrada = false;
                let elegidoAnfitrion = null;
                let elegidoCoanfitrion = null;

                for (let a of preferidosAnfitrion) {
                    for (let c of preferidosCoanfitrion) {
                        if (a === c) continue;
                        const claveDupla = `${a}|${c}`;
                        if (!duplasAsignadas.has(claveDupla)) {
                            elegidoAnfitrion = a;
                            elegidoCoanfitrion = c;
                            duplaEncontrada = true;
                            duplasAsignadas.add(claveDupla);
                            break;
                        }
                    }
                    if (duplaEncontrada) break;
                }
                if (!duplaEncontrada) {
                    let minConteo = Infinity;
                    for (let a of candidatosAnfitrion) {
                        for (let c of candidatosAnfitrion) {
                            if (a === c) continue;
                            const sumaConteo = conteoAsignaciones[a] + conteoAsignaciones[c];
                            if (sumaConteo < minConteo) {
                                minConteo = sumaConteo;
                                elegidoAnfitrion = a;
                                elegidoCoanfitrion = c;
                            }
                        }
                    }
                    if (elegidoAnfitrion && elegidoCoanfitrion) {
                        duplasAsignadas.add(`${elegidoAnfitrion}|${elegidoCoanfitrion}`);
                    }
                }

                // Asignar Anfitrión y Coanfitrión
                if (elegidoAnfitrion) {
                    asignacion['Anfitrión'] = elegidoAnfitrion;
                    conteoAsignaciones[elegidoAnfitrion]++;
                    disponibles = disponibles.filter(p => p !== elegidoAnfitrion);
                }
                if (elegidoCoanfitrion) {
                    asignacion['Coanfitrión'] = elegidoCoanfitrion;
                    conteoAsignaciones[elegidoCoanfitrion]++;
                    disponibles = disponibles.filter(p => p !== elegidoCoanfitrion);
                }

                // Asignar Micrófonos y Plataforma
                ['Micrófono 1', 'Micrófono 2', 'Plataforma'].forEach(rol => {
                    let candidatos = disponibles.filter(p => personas[p].roles.includes(rol));
                    let preferidos = candidatos.filter(p => conteoAsignaciones[p] < 2);
                    if (preferidos.length === 0) preferidos = candidatos.slice();

                    if (preferidos.length > 0) {
                        shuffle(preferidos);
                        let elegido = preferidos.reduce((a, b) =>
                            conteoAsignaciones[a] <= conteoAsignaciones[b] ? a : b
                        );
                        asignacion[rol] = elegido;
                        conteoAsignaciones[elegido]++;
                        disponibles = disponibles.filter(p => p !== elegido);
                    } else {
                        // Elegir aleatoriamente de todos los posibles para evitar "No asignado"
                        const fallback = Object.keys(personas).filter(p => personas[p].roles.includes(rol));
                        shuffle(fallback);
                        const elegido = fallback.find(p => !personasAsignadasAnterior.has(p)) || fallback[0];
                        asignacion[rol] = elegido;
                        conteoAsignaciones[elegido]++;
                    }
                });

                // Agregar al registro de personas asignadas en esta fecha
                personasAsignadasAnterior.clear();
                ['Anfitrión', 'Coanfitrión', 'Micrófono 1', 'Micrófono 2', 'Plataforma'].forEach(rol => {
                    if (asignacion[rol]) {
                        personasAsignadasAnterior.add(asignacion[rol]);
                    }
                });

                const diaNumero = obtenerDiaYNumero(fecha);
                html += `<tr><td style="font-weight:bold">${diaNumero}</td>` +
                    ['Anfitrión', 'Coanfitrión', 'Micrófono 1', 'Micrófono 2', 'Plataforma']
                        .map(r => {
                            const persona = asignacion[r];
                            const color = personas[persona]?.color || '#000';
                            const textoColor = esColorOscuro(color) ? '#fff' : '#000';
                            return `<td 
                        style="background-color:${color}; color:${textoColor}; font-weight:bold; cursor:pointer"
                        data-persona="${persona}" 
                        data-rol="${r}" 
                        data-fecha="${diaNumero}">
                        ${persona}
                    </td>`;
                        })
                        .join('') +
                    '</tr>';
                datosParaGuardar.push({
                    fecha,
                    asignaciones: {
                        Anfitrion: asignacion['Anfitrión'] || '',
                        Coanfitrion: asignacion['Coanfitrión'] || '',
                        Microfono1: asignacion['Micrófono 1'] || '',
                        Microfono2: asignacion['Micrófono 2'] || '',
                        Plataforma: asignacion['Plataforma'] || ''
                    }
                });
            });

            html += `</table>`;
            document.getElementById('asignaciones').innerHTML = html;

            fetch(`${BASE_URL}/asignaciones-generadas`, {
                method: 'POST',
                headers: {
                    'Content-Type': 'application/json'
                },
                body: JSON.stringify(datosParaGuardar)
            })
                .then(res => {
                    if (!res.ok) throw new Error('Error al guardar asignaciones');
                    console.log('✅ Asignaciones guardadas');
                })
                .catch(err => console.error(err));

            document.querySelectorAll('#asignaciones td[data-persona]').forEach(td => {
                td.addEventListener('click', () => {
                    const nombre = td.dataset.persona;
                    const rol = td.dataset.rol;
                    const fecha = td.dataset.fecha;

                    // Mensajes personalizados por rol
                    const mensajes = {
                        'Anfitrión': `Hola ${nombre}, ¿cómo estás?. Para avisarte que estás de Anfitrión el ${fecha}.\n` +
                            `Solo por recordatorio: tener presente llegar al menos 10 minutos antes, para poder preparar los equipos.\n` +
                            `Queremos que la reunión salga lo mejor posible, para que los hermanos puedan disfrutarla y que sea de alabanza a Jehová.\n` +
                            `¡Muchísimas gracias por tu buena disponibilidad!\n` +
                            `Cuando te sea posible, confirmame la asignación.\n` +
                            `¡Un abrazo grande!`,

                        'Coanfitrión': `Hola ${nombre}, ¿cómo estás?. Para avisarte que estás de Co-Anfitrión el ${fecha}.\n` +
                            `Solo por recordatorio: tener presente llegar al menos 10 minutos antes, para poder preparar los equipos y probar micrófonos.\n` +
                            `Queremos que la reunión salga lo mejor posible, para que los hermanos puedan disfrutarla y que sea de alabanza a Jehová.\n` +
                            `¡Muchísimas gracias por tu buena disponibilidad!\n` +
                            `Cuando te sea posible, confirmame la asignación.\n` +
                            `¡Un abrazo grande!`,

                        'Micrófono 1': `Hola ${nombre}, ¿cómo estás?. Para avisarte que estás como Micrófono 1 el ${fecha}.\n` +
                            `¡Muchísimas gracias por tu buena disponibilidad!\n` +
                            `Cuando te sea posible, confirmame la asignación.\n` +
                            `¡Un abrazo grande!`,

                        'Micrófono 2': `Hola ${nombre}, ¿cómo estás?. Para avisarte que estás como Micrófono 2 el ${fecha}.\n` +
                            `¡Muchísimas gracias por tu buena disponibilidad!\n` +
                            `Cuando te sea posible, confirmame la asignación.\n` +
                            `¡Un abrazo grande!`,

                        'Plataforma': `Hola ${nombre}, ¿cómo estás?. Para avisarte que estás como Plataforma el ${fecha}.\n` +
                            `Solo por recordatorio: tener presente llegar al menos 10 minutos antes, para poder probar los micrófonos y la tablet.\n` +
                            `Queremos que la reunión salga lo mejor posible, para que los hermanos puedan disfrutarla y que sea de alabanza a Jehová.\n` +
                            `¡Muchísimas gracias por tu buena disponibilidad!\n` +
                            `Cuando te sea posible, confirmame la asignación.\n` +
                            `¡Un abrazo grande!`
                    };
                    const mensaje = mensajes[rol];

                    navigator.clipboard.writeText(mensaje)
                        .then(() => {
                            td.style.outline = '2px solid limegreen';
                            setTimeout(() => td.style.outline = '', 1000);
                        })
                        .catch(err => {
                            console.error('Error al copiar al portapapeles: ', err);
                        });
                });
            });

        });


        document.getElementById('vaciarEventos').addEventListener('click', async () => {
            if (confirm('¿Seguro que quieres eliminar todas las fechas?')) {
                try {
                    await fetch(`${BASE_URL}/fecha-eventos`, {
                        method: 'DELETE'
                    });
                    cargarFechasEventos(); // recarga desde backend
                } catch (err) {
                    console.error('Error al eliminar los fechas:', err);
                }
            }
        });

        document.getElementById('limpiarNoDisp').addEventListener('click', async () => {
            if (confirm('¿Seguro que quieres eliminar todas las no disponibilidades?')) {
                try {
                    await fetch(`${BASE_URL}/no-disponibilidades`, {
                        method: 'DELETE'
                    });
                    const sel = document.getElementById('personaNoDisponible').value;
                    cargarNoDisponibilidades(); // recarga desde backend
                    actualizarListaNoDisponibilidades(sel);
                } catch (err) {
                    console.error('Error al eliminar todas las no disponibilidades:', err);
                }
            }
        });

        // Limpiar Personas button
        document.getElementById('limpiarPersonas').addEventListener('click', async () => {
            if (confirm('¿Seguro que quieres eliminar todas las personas?')) {
                try {
                    await fetch(`${BASE_URL}/personas`, {
                        method: 'DELETE'
                    });
                    cargarPersonasDesdeBackend(); // recarga personas
                    cargarNoDisponibilidades();   // recarga no disponibilidades
                } catch (err) {
                    console.error('Error al eliminar todas las personas:', err);
                }
            }
        });

        document.getElementById('limpiarPersona').addEventListener('click', async () => {
            const select = document.getElementById('eliminarPersona');
            const personaSeleccionada = select.value;

            if (personaSeleccionada && confirm('¿Seguro que quieres eliminar esta persona?')) {
                try {
                    await fetch(`${BASE_URL}/personas/${encodeURIComponent(personaSeleccionada)}`, {
                        method: 'DELETE'
                    });
                    cargarPersonasDesdeBackend();
                    cargarNoDisponibilidades();
                } catch (err) {
                    console.error('Error al eliminar persona:', err);
                }
            }
        });

    </script>
</body>

</html>